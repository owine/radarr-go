---
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # renovate: datasource=golang-version depName=golang
  GO_VERSION: '1.25.5'
  # renovate: datasource=node-version depName=node
  NODE_VERSION: '24.12.0'
  CACHE_VERSION: 'v3'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Stage 0: Detect which files changed to skip unnecessary jobs
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-24.04
    timeout-minutes: 2
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      workflows: ${{ steps.filter.outputs.workflows }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Detect file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            backend:
              - '**/*.go'
              - 'go.mod'
              - 'go.sum'
              - 'go.work*'
              - 'internal/**'
              - 'cmd/**'
              - 'migrations/**'
              - 'config*.yml'
            frontend:
              - 'web/frontend/**'
              - '**/package*.json'
            workflows:
              - '.github/workflows/**'
            docker:
              - 'Dockerfile*'
              - 'docker-compose*.yml'
              - '.dockerignore'

  # Stage 1: Quality checks and build (optimized for cost and speed)
  quality-and-build:
    needs: detect-changes
    # Run if backend, frontend, workflows, or docker files changed
    if: |
      needs.detect-changes.outputs.backend == 'true' ||
      needs.detect-changes.outputs.frontend == 'true' ||
      needs.detect-changes.outputs.workflows == 'true' ||
      needs.detect-changes.outputs.docker == 'true'
    name: Quality & Build
    runs-on: ubuntu-24.04
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Go with enhanced caching
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            go.sum
            go.work.sum

      - name: Set up Node.js for linting tools
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'


      # Cache linting tools with version-aware keys (v3 for cache cleanup)
      - name: Cache linting tools (version-aware)
        uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # v5.0.0
        id: lint-tools-cache
        with:
          path: |
            ~/go/bin
            ~/.local/bin
            ~/.npm/_global
            ~/.cache/golangci-lint
          key: lint-tools-${{ env.CACHE_VERSION }}-${{ runner.os }}-go${{ env.GO_VERSION }}-node${{ env.NODE_VERSION }}-${{ hashFiles('.golangci*.yml', 'web/frontend/package*.json') }}
          restore-keys: |
            lint-tools-${{ env.CACHE_VERSION }}-${{ runner.os }}-go${{ env.GO_VERSION }}-node${{ env.NODE_VERSION }}-
            lint-tools-${{ env.CACHE_VERSION }}-${{ runner.os }}-go${{ env.GO_VERSION }}-

      - name: Install dependencies and tools (cache-aware optimized)
        run: |
          # Optimize Go module downloads with parallel fetching
          echo "Downloading Go modules with optimizations..."
          go env -w GOPROXY="https://proxy.golang.org,direct"
          go mod download -x
          go work sync

          # Install ESLint and frontend dependencies with proper peer dependency resolution
          if [ -d "web/frontend" ] && [ -f "web/frontend/package.json" ]; then
            echo "Installing ESLint and frontend devDependencies..."
            cd web/frontend
            npm ci --only=dev --prefer-offline --no-audit --no-fund --ignore-scripts
            cd ../..
          fi

      # Install Go tools only if not cached (using step-level conditional)
      - name: Install Go security and linting tools
        if: steps.lint-tools-cache.outputs.cache-hit != 'true'
        run: |
          echo "Installing Go tools (not in cache)..."

          # Install security tools in parallel
          go install github.com/securego/gosec/v2/cmd/gosec@latest &
          GOSEC_PID=$!
          go install golang.org/x/vuln/cmd/govulncheck@latest &
          VULN_PID=$!

          # Install linting tools
          make setup-lint-tools-ci &
          LINT_PID=$!

          # Wait for all installations
          wait $GOSEC_PID $VULN_PID $LINT_PID
          echo "âœ… Tool installations completed"

      - name: Confirm cached tools
        if: steps.lint-tools-cache.outputs.cache-hit == 'true'
        run: echo "âœ… Using cached linting tools (skipping installation)"

      - name: Validate linting tools installation
        run: |
          echo "Validating linting tools installation..."
          make check-lint-tools
          echo "âœ… Linting tools validation completed"

      # Fast parallel linting optimized for CI performance
      - name: Run fast parallel linting (optimized)
        run: |
          echo "ðŸš€ Running optimized fast parallel linting for CI..."
          # Use our new CI-optimized fast linting target
          make lint-ci-fast
          echo "âœ… Critical linting completed successfully"

      - name: Run comprehensive linting validation (optional)
        continue-on-error: true
        run: |
          echo "ðŸ” Running comprehensive linting validation (non-blocking)..."
          # Run additional checks that may have warnings but shouldn't fail CI
          make lint-yaml || echo "âš ï¸  YAML linting issues found (non-blocking)"
          make lint-json || echo "âš ï¸  JSON linting issues found (non-blocking)"
          make lint-markdown || echo "âš ï¸  Markdown linting issues found (non-blocking)"
          make lint-shell || echo "âš ï¸  Shell script linting issues found (non-blocking)"
          echo "ðŸ“‹ Comprehensive validation completed"

      - name: Generate linting summary
        if: always()
        run: |
          echo "## ðŸ” Comprehensive Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Critical Linting (Must Pass)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Go code linting (golangci-lint)" >> $GITHUB_STEP_SUMMARY
          if [ -d "web/frontend" ] && [ -f "web/frontend/package.json" ]; then
            echo "- âœ… Frontend TypeScript/React linting (ESLint)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- â­ï¸ Frontend linting skipped (no frontend detected)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Additional Linting (Warnings Only)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ YAML files (yamllint)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“„ JSON files (jsonlint/python)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ Markdown files (markdownlint)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš Shell scripts (shellcheck)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ› ï¸ Available Linting Commands" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Run all linting" >> $GITHUB_STEP_SUMMARY
          echo "make lint-all" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Run specific linting" >> $GITHUB_STEP_SUMMARY
          echo "make lint-go lint-frontend lint-yaml lint-json lint-markdown lint-shell" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Auto-fix linting issues" >> $GITHUB_STEP_SUMMARY
          echo "make lint-fix" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Run security checks in parallel
        run: |
          # Run security checks in background
          gosec -fmt sarif -out gosec.sarif ./... &
          GOSEC_PID=$!

          # Run vulnerability check in background
          govulncheck ./... &
          VULN_PID=$!

          # Formatting check is now handled by lint-go target

          # Wait for security checks
          wait $GOSEC_PID $VULN_PID

      - name: Upload SARIF file
        if: always() && hashFiles('gosec.sarif') != ''
        uses: github/codeql-action/upload-sarif@1b168cd39490f61582a9beae412bb7057a6b2c4e # v4.31.8
        with:
          sarif_file: gosec.sarif
        continue-on-error: true

      - name: Check Go modules
        run: |
          go mod tidy
          go work sync
          # Only check core module files, allow workspace sum to update
          if ! git diff --quiet go.mod go.sum; then
            echo "go.mod or go.sum needs to be updated"
            git diff go.mod go.sum
            exit 1
          fi
          # Show workspace changes but don't fail
          if ! git diff --quiet go.work.sum; then
            echo "go.work.sum was updated by workspace sync (this is expected)"
            git diff --stat go.work.sum
          fi

      # Cache Go build artifacts (v3 for cache cleanup)
      - name: Cache Go build artifacts
        uses: actions/cache@a7833574556fa59680c1b7cb190c1735db73ebf0 # v5.0.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg
          key: go-build-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-build-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.GO_VERSION }}-

      # Build all artifacts in single job (major cost savings)
      - name: Build multi-platform artifacts
        run: |
          mkdir -p artifacts

          # Set build variables
          VERSION=${GITHUB_REF_NAME:-dev}
          COMMIT=${GITHUB_SHA::8}
          BUILD_DATE=$(date -u '+%Y-%m-%d_%H:%M:%S')
          LDFLAGS="-w -s -X 'main.version=${VERSION}' -X 'main.commit=${COMMIT}' -X 'main.date=${BUILD_DATE}'"

          # Build test binary first
          CGO_ENABLED=0 go build -ldflags="${LDFLAGS}" -o artifacts/radarr-test ./cmd/radarr

          # Parallel builds for all platforms (much faster than separate jobs)
          echo "Building all platform binaries in parallel..."

          # Linux builds
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 \
            go build -ldflags="${LDFLAGS}" -o artifacts/radarr-linux-amd64 ./cmd/radarr &
          GOOS=linux GOARCH=arm64 CGO_ENABLED=0 \
            go build -ldflags="${LDFLAGS}" -o artifacts/radarr-linux-arm64 ./cmd/radarr &

          # Darwin builds
          GOOS=darwin GOARCH=amd64 CGO_ENABLED=0 \
            go build -ldflags="${LDFLAGS}" -o artifacts/radarr-darwin-amd64 ./cmd/radarr &
          GOOS=darwin GOARCH=arm64 CGO_ENABLED=0 \
            go build -ldflags="${LDFLAGS}" -o artifacts/radarr-darwin-arm64 ./cmd/radarr &

          # Windows builds
          GOOS=windows GOARCH=amd64 CGO_ENABLED=0 \
            go build -ldflags="${LDFLAGS}" -o artifacts/radarr-windows-amd64.exe ./cmd/radarr &
          GOOS=windows GOARCH=arm64 CGO_ENABLED=0 \
            go build -ldflags="${LDFLAGS}" -o artifacts/radarr-windows-arm64.exe ./cmd/radarr &

          # FreeBSD builds
          GOOS=freebsd GOARCH=amd64 CGO_ENABLED=0 \
            go build -ldflags="${LDFLAGS}" -o artifacts/radarr-freebsd-amd64 ./cmd/radarr &
          GOOS=freebsd GOARCH=arm64 CGO_ENABLED=0 \
            go build -ldflags="${LDFLAGS}" -o artifacts/radarr-freebsd-arm64 ./cmd/radarr &

          # Wait for all builds to complete
          wait
          echo "All builds completed"
          ls -la artifacts/

      - name: Validate build version handling
        run: |
          echo "ðŸ” Validating build version injection system..."

          # Use build version validation script
          chmod +x ./.github/scripts/validate-build-version.sh
          ./.github/scripts/validate-build-version.sh artifacts/radarr-test

          echo "âœ… Build version validation completed"

      - name: Store build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: build-artifacts
          path: artifacts/
          retention-days: 7
          compression-level: 9

  # Stage 2: PostgreSQL Database Tests
  test-postgres:
    name: Database Tests (postgres)
    runs-on: ubuntu-24.04
    needs: [detect-changes, quality-and-build]
    # Run if backend code changed
    if: needs.detect-changes.outputs.backend == 'true'
    timeout-minutes: 20

    services:
      postgres:
        image: postgres:18.1-alpine@sha256:eca6fb2d91fda290eb8cfb8ba53dd0dcbf3508a08011e30adb039ea7c8e1e9f2
        env:
          POSTGRES_PASSWORD: test_password_123
          POSTGRES_USER: test_user
          POSTGRES_DB: radarr_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Reuse enhanced caching from previous job
      - name: Set up Go with enhanced caching
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            go.sum
            go.work.sum

      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-artifacts
          path: ./artifacts

      # Restore build cache for faster test compilation (read-only, v3)
      - name: Restore Go build cache
        uses: actions/cache/restore@a7833574556fa59680c1b7cb190c1735db73ebf0 # v5.0.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg
          key: go-build-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-build-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.GO_VERSION }}-

      - name: Setup test environment
        run: |
          mkdir -p data movies web/static web/templates
          cp config.ci.postgres.yml data/config.yml

      - name: Run comprehensive tests with optimized parallelization
        run: |
          # Run unit tests with package parallelization only (faster for small test suites)
          echo "Running unit tests with package parallelization..."
          go test -v -race \
            -p 4 \
            -coverprofile=coverage-postgres.out \
            -timeout 10m \
            ./...

          # Run benchmarks and examples sequentially (avoid background overhead)
          echo "Running benchmark tests..."
          go test -bench=. -benchmem -run=^$ -p 2 ./...

          echo "Running example tests..."
          go test -run=Example -p 2 ./...
        env:
          RADARR_DATABASE_TYPE: postgres
          RADARR_DATABASE_HOST: localhost
          RADARR_DATABASE_PORT: 5432
          RADARR_DATABASE_DATABASE: radarr_test
          RADARR_DATABASE_USERNAME: test_user
          RADARR_DATABASE_PASSWORD: test_password_123
          GOMAXPROCS: 4

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-postgres.out
          flags: unittests,postgres
          name: coverage-postgres

      - name: Integration test
        run: |
          # Use Linux amd64 binary for postgres testing
          chmod +x artifacts/radarr-linux-amd64

          # Start application with timeout
          timeout 30s artifacts/radarr-linux-amd64 \
            --data ./data --config ./data/config.yml &
          RADARR_PID=$!
          sleep 10

          # Test core API endpoints
          curl -f http://localhost:7878/ping || exit 1
          curl -f http://localhost:7878/api/v3/system/status || exit 1
          curl -f http://localhost:7878/api/v3/movie || exit 1

          # Cleanup
          kill $RADARR_PID || true
          wait $RADARR_PID || true
        env:
          RADARR_DATABASE_TYPE: postgres
          RADARR_DATABASE_HOST: localhost
          RADARR_DATABASE_PORT: 5432
          RADARR_DATABASE_DATABASE: radarr_test
          RADARR_DATABASE_USERNAME: test_user
          RADARR_DATABASE_PASSWORD: test_password_123

  # Stage 3: MariaDB Database Tests
  test-mariadb:
    name: Database Tests (mariadb)
    runs-on: ubuntu-24.04
    needs: [detect-changes, quality-and-build]
    # Run if backend code changed
    if: needs.detect-changes.outputs.backend == 'true'
    timeout-minutes: 20

    services:
      mariadb:
        image: mariadb:12.1.2@sha256:e1bcd6f85781f4a875abefb11c4166c1d79e4237c23de597bf0df81fec225b40
        env:
          MYSQL_ROOT_PASSWORD: test_root_password_123
          MYSQL_DATABASE: radarr_test
          MYSQL_USER: test_user
          MYSQL_PASSWORD: test_password_123
        options: >-
          --health-cmd="mariadb-admin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Reuse enhanced caching from previous job
      - name: Set up Go with enhanced caching
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            go.sum
            go.work.sum

      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-artifacts
          path: ./artifacts

      # Restore build cache for faster test compilation (read-only, v3)
      - name: Restore Go build cache
        uses: actions/cache/restore@a7833574556fa59680c1b7cb190c1735db73ebf0 # v5.0.0
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg
          key: go-build-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.GO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-build-${{ env.CACHE_VERSION }}-${{ runner.os }}-${{ env.GO_VERSION }}-

      - name: Setup test environment
        run: |
          mkdir -p data movies web/static web/templates
          cp config.ci.mariadb.yml data/config.yml

      - name: Run comprehensive tests with parallelization
        run: |
          # Run tests with parallel execution for faster completion
          echo "Running parallel unit tests..."
          go test -v -race \
            -p 4 -parallel 4 \
            -coverprofile=coverage-mariadb.out \
            -timeout 10m \
            ./...

          # Run benchmarks and examples in parallel (background)
          echo "Running benchmark tests in parallel..."
          go test -bench=. -benchmem -run=^$ -p 2 ./... &
          BENCH_PID=$!

          echo "Running example tests in parallel..."
          go test -run=Example -p 2 ./... &
          EXAMPLE_PID=$!

          # Wait for parallel tests to complete
          wait $BENCH_PID $EXAMPLE_PID
        env:
          RADARR_DATABASE_TYPE: mariadb
          RADARR_DATABASE_HOST: localhost
          RADARR_DATABASE_PORT: 3306
          RADARR_DATABASE_DATABASE: radarr_test
          RADARR_DATABASE_USERNAME: test_user
          RADARR_DATABASE_PASSWORD: test_password_123
          GOMAXPROCS: 4

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage-mariadb.out
          flags: unittests,mariadb
          name: coverage-mariadb

      - name: Integration test
        run: |
          # Use Linux amd64 binary for mariadb testing
          chmod +x artifacts/radarr-linux-amd64

          # Start application with timeout
          timeout 30s artifacts/radarr-linux-amd64 \
            --data ./data --config ./data/config.yml &
          RADARR_PID=$!
          sleep 10

          # Test core API endpoints
          curl -f http://localhost:7878/ping || exit 1
          curl -f http://localhost:7878/api/v3/system/status || exit 1
          curl -f http://localhost:7878/api/v3/movie || exit 1

          # Cleanup
          kill $RADARR_PID || true
          wait $RADARR_PID || true
        env:
          RADARR_DATABASE_TYPE: mariadb
          RADARR_DATABASE_HOST: localhost
          RADARR_DATABASE_PORT: 3306
          RADARR_DATABASE_DATABASE: radarr_test
          RADARR_DATABASE_USERNAME: test_user
          RADARR_DATABASE_PASSWORD: test_password_123

  # Stage 4: Streamlined publish (major cost savings)
  publish:
    name: Publish Test Images and Artifacts
    runs-on: ubuntu-24.04
    needs: [test-postgres, test-mariadb]
    if: >
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    timeout-minutes: 20

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download build artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: build-artifacts
          path: ./artifacts

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Log in to Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-,format=short
            type=raw,value=nightly,enable={{is_default_branch}}
            type=raw,value=dev-latest,enable={{is_default_branch}}
            type=raw,value=commit-{{sha}},enable={{is_default_branch}}
            type=raw,value={{date 'YYYY.MM.DD'}}-nightly,enable={{is_default_branch}}
            type=raw,value=pr-{{.Number}},enable=${{ github.event_name == 'pull_request' }}

      - name: Build and push Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: .
          file: ./Dockerfile.artifacts
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            VERSION=${{ github.ref_name }}
            COMMIT=${{ github.sha }}
            BUILD_DATE=${{ steps.meta.outputs.created || github.event.head_commit.timestamp }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Publish artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: published-artifacts-${{ github.ref_name }}
          path: artifacts/
          retention-days: 30
          compression-level: 9

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ Optimized CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’° Cost Optimizations Applied" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Consolidated 6 separate test jobs into 2 efficient database tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Eliminated expensive macOS runners (savings: ~80% on runner costs)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Combined quality checks, security, and builds in single job" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Parallel cross-compilation replaces multiple platform-specific jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Speed Optimizations Applied" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Enhanced Go module and build caching across jobs" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Parallel security checks and tool installation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Parallel cross-compilation of all platform binaries" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Reduced job dependencies and setup overhead" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Published Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Images**: ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Available Binaries" >> $GITHUB_STEP_SUMMARY
          ls -la artifacts/ >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ Docker Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "**Development Build (Latest from main):**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "# Latest nightly build" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:nightly" >> $GITHUB_STEP_SUMMARY
            echo "docker run -d -p 7878:7878 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:nightly" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "# Specific commit build" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:commit-${{ github.sha }}" >> \
              $GITHUB_STEP_SUMMARY
            echo "docker run -d -p 7878:7878 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:commit-${{ github.sha }}" >> \
              $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "**Pull Request Build:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ github.event.number }}" >> \
              $GITHUB_STEP_SUMMARY
            echo "docker run -d -p 7878:7878 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ github.event.number }}" >> \
              $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> \
              $GITHUB_STEP_SUMMARY
            echo "docker run -d -p 7878:7878 ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> \
              $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Available Tags" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "- \`:nightly\` - Latest development build" >> $GITHUB_STEP_SUMMARY
            echo "- \`:dev-latest\` - Alias for latest development build" >> $GITHUB_STEP_SUMMARY
            echo "- \`:commit-${{ github.sha }}\` - This specific commit" >> $GITHUB_STEP_SUMMARY
            echo "- \`:$(date +%Y.%m.%d)-nightly\` - Dated nightly build" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "- \`:pr-${{ github.event.number }}\` - Pull request build" >> $GITHUB_STEP_SUMMARY
          fi
